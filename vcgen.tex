\newcommand{\existformula}{\psi^e}
\newcommand{\EA}{\textsc{ea}}
\newcommand{\IW}{\textsc{iw}}

\newcommand{\initformula}{\logicalformula{init}}

\section{Checking Purity Using a Theorem Prover}

\subsection{Verification Condition Generation}

We describe an adaptation of standard verification-condition generation techniques that we use as our first step.
Given a procedure $\procP$, a candidate invariant $\inv$, the function $\mainvc{\procP}{\inv}$ returns a
pair $(\post,\vc)$ where $\post$ is a postcondition describing the state that exists after an execution of
$\procP$ starting from a state that satisfies $\inv$, and $\vc$ is a verification-condition that must hold true
for the execution to satisfy its invariants and assertions.

We use an auxiliary function $\auxvcfn$ which is similar to $\mainvcfn$, but accepts a statement $\stmtS$ as
parameter instead of a procedure, and it has an extra parameter $\pre$ that is a precondition describing
the state before the execution of the statement.
Fig.~\ref{fig:vcgen} contains a definition of $\mainvc{\procP}{\inv}$  and  $\auxvc{\stmtS}{\inv}{\pre}$.

\begin{figure}
\begin{mathpar}

\inferrule{
\proc = \code{p (n) \{ \stmt ; return x \} } \\
\initformula = \wedge_g (g = 0) \\
\auxvc{\stmt}{\inv}{\inv} = (\post, \vc)
}{
\mainvc{\proc}{\inv} = (\post, (\initformula \Rightarrow \inv) \wedge \vc \wedge (\post \Rightarrow \inv))
}

\inferrule{
\auxvc{\stmtSA}{\inv}{\pre} = (\postA, \vcA) \\
\auxvc{\stmtSB}{\inv}{\postA} = (\postB, \vcB) 
}{
\auxvc{ \stmtSA ; \stmtSB }{\inv}{\pre} = (\postB, \vcA \wedge \vcB)
}

\inferrule{
\auxvc{\stmtSA}{\inv}{\pre \wedge \expr} = (\postA, \vcA) \\
\auxvc{\stmtSB}{\inv}{\pre \wedge \neg \expr} = (\postB, \vcB) 
}{
\auxvc{ \code{if } \; \expr \; \code{ then } \;  \stmtSA \;  \code{ else } \; \stmtSB }{\inv}{\pre} = (\postA \vee \postB, \vcA \wedge \vcB)
}

\inferrule{
\var \not\in vars(\expr)
}{
\auxvc{\var = \expr}{\inv}{\pre} = ((\exists \var. \pre) \wedge (\var = \expr), \code{true})
}

\inferrule{
\varY \neq \var \\ \varY \neq g
}{
\auxvc{\var = \proc(\varY)}{\inv}{\pre} = ((\exists g. \exists \var.\pre) \wedge \inv \wedge (\var = F(\varY)), \pre \Rightarrow \inv)
}

\end{mathpar}
\caption{Generation of verification-condition and postcondition.}
\label{fig:vcgen}
\end{figure}

\subsection{Existential Approach}

Let $\proc$ be a procedure with input parameter $n$ and return variable $r$.
Let $\mainvc{\proc}{\inv}$ = $(\post,\vc)$.
Let $\existformula$ denote the formula $\vc \wedge (\post \Rightarrow (r = p(n)))$.
Let $\overline{x}$ denote the sequence of all free variables in $\existformula$ except for $p$.
We define $\EA(\proc,\inv)$ to be the formula $ \forall \overline{x}. \existformula$.

\begin{theorem}
\label{theorem:EA}
A procedure $\proc$ is observationally pure and satisfies invariant $\inv$ if
$\exists p. \EA(\proc,\inv)$ is a tautology
(which holds iff $\EA(\proc,\inv)$ is satisfiable).
\end{theorem}

\begin{proof}
Note that $p$ is the only free variable in $\EA(\proc,\inv)$. Assume that $[p \mapsto f]$ is a
satisfying assignment for $\EA(\proc,\inv)$.
We prove that for every trace $\pi$ the following hold:
(a) $\outputval{\pi} = f(\inputval{\pi})$ and
(b) If $(\initial{\pi},f)$ satisfies $\inv$, then $(\final{\pi},f)$ also satisfies $\inv$.

The proof is by contradiction. Let $\pi$ be the shortest trace that does not satisfy at least
one of the two conditions (a) and (b).

Let us first consider a trace $\pi$ without any sub-traces (\ie, without a procedure call).
Consider any transition $\sigma_i \sssemP \sigma_{i+1}$ in $\pi$
caused by an assignment statement $\stmt$. Our verification-condition generation produces
a precondition $\pre_{\stmt}$ and a postcondition $\post_{\stmt}$ for $\stmt$. Further, this generation
guarantees that if $(\sigma_i,f)$ satisfies $\pre_{\stmt}$, then $(\sigma_{i+1},f)$ satisfies $\post_{\stmt}$.
This lets us prove (via induction over $i$), that if $(\initial{\pi},f)$ satisfies $\inv$,
then $(\sigma_{i+1},f)$ satisfies $\post_{\stmt}$.

We now consider a trace $\pi$ that contains a sub-trace $\pi' = \sigma_i \cdots \sigma_j$ corresponding to a procedure call
statement $\stmt$. Our verification-condition generation produces a precondition $\pre_{\stmt}$,
a postcondition $\post_{\stmt}$  and a conjunct $\pre_{\stmt} \Rightarrow \inv$ in $\vc$ for $\stmt$.
We extend the induction over $i$ to handle recursive calls as below.
Our inductive hypothesis guarantees that $(\sigma_i,f)$ satisfies $\pre_{\stmt}$.
Further, we know that $[p \mapsto f]$ is a satisfying assignment for $\EA(\proc,\inv)$,
which includes the conjunct $\pre_{\stmt} \Rightarrow \inv$. Hence, it follows that  $(\sigma_i,f)$ satisfies $\inv$.
Since $\pi'$ is a shorter trace than $\pi$, we can assume that it satisfies conditions (a)
and (b). This is sufficient to guarantee that $(\sigma_j,f)$ satisfies $\post_{\stmt}$.

Thus, we can establish $(\final{\pi},f)$ satisfies $\post$ and $\inv$. Further, since 
$\EA(\proc,\inv)$ includes the conjunct $\post \Rightarrow (r = p(n))$, it follows that
$\outputval{\pi} = f(\inputval{\pi})$.
\end{proof}

\subsection{Impurity Witness Approach}

Let $\proc$ be a procedure with input parameter $n$ and return variable $r$.
Let $\mainvc{\proc}{\inv}$ = $(\post,\vc)$.
Let $\post_\alpha$ denote the formula obtained by replacing every free variable $x$ other than $p$ in $\post$
by a new free variable $x_\alpha$. Define $\post_\beta$ similarly.
Define $\IW(\proc, \inv)$ to be the formula $(\neg \vc) \vee (\post_\alpha \wedge \post_\beta \wedge (n_\alpha = n_\beta) \wedge (r_\alpha \neq r_\beta))$.

\begin{theorem}
A procedure $\proc$ is observationally pure and satisfies invariant $\inv$
if $\IW(\proc, \inv)$ is unsatisfiable.
\end{theorem}

\begin{proof}
%Let  $\vartheta$ denote the formula  $\exists p \forall \overline{x} (\vc \wedge (\post \Rightarrow (r = p(n))$
%used in the existential approach.
%Consider the formula $\vartheta'$ = $(\forall p \forall \overline{x} \vc) \wedge (\exists p \forall \overline{x} (\post \Rightarrow (r = p(n))))$.
%It can be verified that $\vartheta'$ is a stronger condition than $\vartheta$.
%Thus, if $\vartheta'$ can be verified to be a tautology, then it follows that $\vartheta$ is also a tautology,
%and it follows from Theorem~\ref{theorem:EA} that $\proc$ is observationally pure and satisfies invariant $\inv$.
%
%The impurity witness approach essentially checks the stronger formula $\vartheta'$. Since it is a conjunction,
%we can check each conjunct separately.
%
%We can check if $(\forall p \forall \overline{x} \vc)$ holds by checking
%if $\neg \vc$ is not satisfiable.
%
%Now consider the second condition $\exists p \forall \overline{x} \post \Rightarrow (r = p(n))$.
%We now show that if $(\post_\alpha \wedge \post_\beta \wedge (n_\alpha = n_\beta) \wedge (r_\alpha \neq r_\beta))$
%is unsatisfiable, then the second condition must hold true. 
%Assume that $\exists p \forall \overline{x} \post \Rightarrow (r = p(n))$ does not hold. Consider any function $p$.
%Since $\forall \overline{x} \post \Rightarrow (r = p(n))$ does not hold (for this $p$), consider the set $C$ of all
%valuations to $\overline{x}$ such that $\post$ holds. Note that every every element of $C$ assigns a value to every
%free variable, including $r$ and $n$. Suppose we have two elements $\alpha'$ and $\beta'$ in $C$ that agree on the
%value of $n$ but have different values for $r$, then these give us a satisfying assignment to
%$(\post_\alpha \wedge \post_\beta \wedge (n_\alpha = n_\beta) \wedge (r_\alpha \neq r_\beta))$.
%If not two such elements exist, ...
\end{proof}